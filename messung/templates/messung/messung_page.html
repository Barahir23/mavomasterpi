{% extends "layout.html" %}
{% load static %}

{% block title %}Messdatenerfassung{% endblock %}

{% block content %}
<!-- Button zum Öffnen der Seitenleiste auf mobilen Geräten -->
<button id="menuToggleButton" class="btn-icon">☰</button>

<!-- Seitenleiste für die Konfiguration -->
<aside id="controls-sidebar">
    <div class="sidebar-header">
        <h2>Einstellungen</h2>
    </div>

    <div class="control-group">
        <h3>Projekt</h3>
        <div class="select-wrapper">
            <select id="selectProjekt">
                <option value="">--- Bitte wählen ---</option>
                {% for projekt in projekte %}
                    <option value="{{ projekt.id }}">{{ projekt.code }} {{ projekt.name }}</option>
                {% endfor %}
            </select>
            <button id="btnToggleProjektAccordion" class="expand-button">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
        <div id="projektFormContainer" class="expandable-form-container">
            <form id="projektForm">
                <label for="projektCode">Code:</label><input type="text" id="projektCode" required>
                <label for="projektName">Name:</label><input type="text" id="projektName" required>
                <label for="projektBeschreibung">Beschreibung:</label><textarea id="projektBeschreibung"></textarea>
                <div class="button-group">
                    <button type="submit" id="projektFormSubmitButton" class="btn-primary btn-text" disabled>Speichern</button>
                    <button type="button" id="btnDeleteProjekt" class="btn-danger btn-text" disabled>Löschen</button>
                    <button type="button" id="btnNewProjekt" class="btn-secondary btn-text">Neues Projekt</button>
                </div>
            </form>
        </div>
    </div>

    <div class="control-group">
        <h3>Objekt</h3>
        <div class="select-wrapper">
            <select id="selectObjekt" disabled>
                <option value="">--- Erst Projekt wählen ---</option>
            </select>
            <button id="btnToggleObjektAccordion" class="expand-button" disabled>
                 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
        </div>
        <div id="objektFormContainer" class="expandable-form-container">
            <form id="objektForm">
                <label for="objektNummer">Nummer:</label><input type="text" id="objektNummer" required>
                <label for="objektName">Name:</label><input type="text" id="objektName" required>
                <div class="button-group">
                    <button type="submit" id="objektFormSubmitButton" class="btn-primary btn-text" disabled>Speichern</button>
                    <button type="button" id="btnDeleteObjekt" class="btn-danger btn-text" disabled>Löschen</button>
                    <button type="button" id="btnNewObjekt" class="btn-secondary btn-text" disabled>Neues Objekt</button>
                </div>
            </form>
        </div>
    </div>

    <div class="control-group">
        <h3>Messsequenz</h3>
        <div class="control-grid">
            <div>
                <label for="inputInterval">Intervall (1-10s)</label>
                <input type="number" id="inputInterval" value="1" min="1" max="10">
            </div>
            <div>
                <label for="inputCount">Anzahl (2-100)</label>
                <input type="number" id="inputCount" value="20" min="2" max="100">
            </div>
        </div>
    </div>
</aside>

<!-- Hauptinhalt der Seite -->
<div id="main-content">
    <section>
        <div class="control-group">
            <h3 class="title-with-info">
                Messgerät
                <span id="device-info-display" class="info"></span>
            </h3>
            <div class="device-control-row">
                <button id="btnConnect" class="btn-text">Verbinden</button>
                <div id="status-bar">Status: Nicht verbunden</div>
            </div>
        </div>

        <div class="control-group">
            <div class="title-with-info">
                <h3>Messung</h3>
                <button id="btnToggleMessungAccordion" class="expand-button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
            </div>
            <div id="messungFormContainer" class="expandable-form-container">
                <div class="control-grid">
                    <div>
                        <label for="inputMesshoehe">Messhöhe</label>
                        <input type="number" id="inputMesshoehe" value="0.75" placeholder="z.B. 0.85" step="0.01">
                    </div>
                    <div>
                        <label for="selectAnforderung">Anforderung</label>
                        <div class="select-wrapper">
                            <select id="selectAnforderung">
                                <option value="">--- Optional ---</option>
                                {% for anforderung in anforderungen %}
                                    <option value="{{ anforderung.id }}">{{ anforderung.ref }} {{ anforderung.typ }}</option>
                                {% endfor %}
                            </select>
                            <button id="btnNewAnforderung" class="btn-icon" title="Neue Anforderung anlegen">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <label for="inputMessbedingungen">Messbedingungen</label>
                        <textarea id="inputMessbedingungen" rows="3">Leuchten auf 100%, Lamellenstoren geschlossen</textarea>
                    </div>
                </div>
            </div>
            <div class="control-grid">
                <div class="device-actions">
                    <button id="btnSingle" class="btn-text" disabled>Einzelmessung</button>
                    <div id="realtime-display">--.-</div>
                </div>
                <div class="device-actions">
                    <label>Sequenzsteuerung</label>
                    <button id="btnStartSeq" class="btn-icon" title="Starten" disabled>
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                    </button>
                    <button id="btnStopSeq" class="btn-icon btn-danger" title="Stoppen" disabled>
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"></path></svg>
                    </button>
                </div>
            </div>
            <div class="button-group">
                <button id="btnSave" class="btn-primary btn-text" disabled>Messungen speichern</button>
                <button id="btnDeleteAll" class="btn-danger btn-text" disabled>Anzeige zurücksetzen</button>
                <button id="btnExport" class="btn-secondary btn-text" disabled>Protokoll exportieren (XLSX)</button>
            </div>
            <div id="table-container">
                <table id="measurementTable">
                    <thead>
                        <tr id="header-row-1">
                            <th rowspan="2">Zeit</th>
                            <th colspan="2">Einzelmessung</th>
                        </tr>
                        <tr id="header-row-2">
                            <th>Messwert</th>
                            <th>Kommentar</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Modals -->
    <div id="deviceWarningModal" class="modal">
        <div class="modal-content">
            <h3>Gerätewarnung</h3>
            <p>Das Messgerät wurde möglicherweise nicht korrekt erkannt. Es wird empfohlen, den Raspberry Pi neu zu starten.</p>
            <div class="button-group">
                <button id="rebootConfirmBtn" class="btn-warning btn-text">Jetzt neu starten</button>
                <button id="rebootDeclineBtn" class="btn-secondary btn-text">Trotzdem fortfahren</button>
            </div>
        </div>
    </div>
    <div id="anforderungModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Neue Anforderung anlegen</h3>
            <form id="anforderungForm">
                <label>Referenz</label><input type="text" id="anforderungRef" required>
                <label>Typ</label><input type="text" id="anforderungTyp">
                <label>E mittel</label><input type="number" step="any" id="anforderungAvg">
                <label>E mittel, modifiziert</label><input type="number" step="any" id="anforderungAvgmod">
                <label>Gleichmässigkeit, U0</label><input type="number" step="any" id="anforderungU0">
                <button type="submit" class="btn-primary btn-text">Speichern</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block footerscripts %}
<script src="{% static 'js/messung.js' %}"></script>
{% endblock %}
