{% extends "layout.html" %}
{% block title %}Projekte – MavoMaster{% endblock %}
{% block sidebar_context %}
  {% if selected_objekt and not selected_messung %}
    <nav class="sidebar-nav always-visible">
      <a href="{% url 'messung:page' %}?objekt={{ selected_objekt.id }}" class="nav-item" title="Messung hinzufügen">
        <span class="icon">{% include "icons/document-plus.svg" %}</span><span class="label">Messung hinzufügen</span>
      </a>
    </nav>
  {% endif %}
  {% if selected_projekt %}
    {% include "messung/projek_edit.html" %}
  {% endif %}
  {% if selected_objekt %}
    {% include "messung/objekt_edit.html" %}
  {% endif %}
  {% if selected_messung %}
    {% include "messung/messung_edit.html" %}
  {% endif %}
{% endblock %}
{% block content %}
  <div class="element-columns">
    <div class="column">
      {% for projekt in projekte %}
        <section class="card element-card projekt-card has-delete{% if selected_projekt and projekt.id == selected_projekt.id %} selected{% endif %}">
          <a href="{% url 'projekte_page' %}?projekt={{ projekt.id }}">
            <h2>{{ projekt.code }}</br>{{ projekt.name }}</h2>
          </a>
          <form method="post" action="{% url 'projekt_delete' projekt.id %}" onsubmit="return confirm('Möchten Sie wirklich löschen?');">
            {% csrf_token %}
            <button type="submit" class="delete-btn" title="Löschen">
              <span class="icon">{% include "icons/trash.svg" %}</span>
            </button>
          </form>
        </section>
      {% empty %}
        <section class="card"><p>Keine Projekte vorhanden.</p></section>
      {% endfor %}
    </div>
    <div class="column">
      {% if selected_projekt %}
        {% for objekt in objekte %}
          <section class="card element-card objekt-card has-delete{% if selected_objekt and objekt.id == selected_objekt.id %} selected{% endif %}">
            <a href="{% url 'projekte_page' %}?projekt={{ selected_projekt.id }}&objekt={{ objekt.id }}">
              <h3>{{ objekt.nummer }}</br>{{ objekt.name }}</h3>
            </a>
            <form method="post" action="{% url 'objekt_delete' objekt.id %}" onsubmit="return confirm('Möchten Sie wirklich löschen?');">
              {% csrf_token %}
              <button type="submit" class="delete-btn" title="Löschen">
                <span class="icon">{% include "icons/trash.svg" %}</span>
              </button>
            </form>
          </section>
        {% empty %}
          <section class="card"><p>Keine Objekte vorhanden.</p></section>
        {% endfor %}
      {% endif %}
    </div>
    <div class="column">
      {% if selected_objekt %}
        {% for messung in messungen %}
          <section class="card element-card messung-card has-delete{% if selected_messung and messung.id == selected_messung.id %} selected{% endif %}">
            <a href="{% url 'projekte_page' %}?projekt={{ selected_projekt.id }}&objekt={{ selected_objekt.id }}&messung={{ messung.id }}">
              <h4>{{ messung.name }}</h4>
            </a>
            <form method="post" action="{% url 'messung_delete' messung.id %}" onsubmit="return confirm('Möchten Sie wirklich löschen?');">
              {% csrf_token %}
              <button type="submit" class="delete-btn" title="Löschen">
                <span class="icon">{% include "icons/trash.svg" %}</span>
              </button>
            </form>
          </section>
        {% empty %}
          <section class="card"><p>Keine Messungen vorhanden.</p></section>
        {% endfor %}
      {% endif %}
    </div>
  </div>
{% endblock %}
{% block extra_js %}
{% if selected_projekt or selected_objekt or selected_messung %}
<script>
  document.documentElement.classList.remove('sidebar-collapsed');
  document.body.classList.remove('sidebar-collapsed');
  try { localStorage.setItem('mm.sidebar.collapsed','0'); } catch(e){}
</script>
{% endif %}
<script>
  function collapse(selector){
    const body = document.querySelector(selector);
    const toggle = document.querySelector(`[data-target="${selector}"]`);
    if(body && toggle){
      body.classList.add('collapsed');
      toggle.classList.add('collapsed');
    }
  }

  document.querySelectorAll('.accordion-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = document.querySelector(btn.dataset.target);
      target.classList.toggle('collapsed');
      btn.classList.toggle('collapsed');
    });
  });

  {% if selected_objekt %}
  collapse('#projekt-fields');
  {% endif %}
  {% if selected_messung %}
  collapse('#objekt-fields');
  {% endif %}

  document.querySelectorAll('.edit-form').forEach(form => {
    const saveBtn = form.querySelector('.save-btn');
    if(saveBtn){
      saveBtn.disabled = true;
      form.addEventListener('input', () => {
        saveBtn.disabled = false;
        saveBtn.classList.add('unsaved');
      });
      form.addEventListener('submit', () => {
        saveBtn.classList.remove('unsaved');
        saveBtn.disabled = true;
      });
    }
  });
</script>
{% endblock %}
