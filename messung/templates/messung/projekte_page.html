{% extends "layout.html" %}
{% load static %}
{% block title %}Projekte – MavoMaster{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/messung.css' %}">
{% endblock %}
{% block sidebar_context %}
  {% include "messung/projek_edit.html" %}
  {% if selected_projekt %}
    {% include "messung/objekt_edit.html" %}
  {% endif %}
  {% if selected_messung %}
    <div class="card" id="sidebar-stats">
      <h3>Statuswerte</h3>
      {% include "stats_table.html" %}
    </div>
  {% endif %}
{% endblock %}
{% block content %}
  <div class="element-columns">
    <div class="column">
      {% for projekt in projekte %}
        <section class="card element-card projekt-card has-delete{% if selected_projekt and projekt.id == selected_projekt.id %} selected{% endif %}">
          <a href="{% url 'projekte_page' %}?projekt={{ projekt.id }}">
            <h2>{{ projekt.code }}</br>{{ projekt.name }}</h2>
          </a>
          <form method="post" action="{% url 'projekt_delete' projekt.id %}">
            {% csrf_token %}
            <button type="submit" class="delete-btn action-btn" title="Löschen">
              <span class="icon">{% include "icons/trash.svg" %}</span>
            </button>
          </form>
        </section>
      {% empty %}
        <section class="card"><p>Keine Projekte vorhanden.</p></section>
      {% endfor %}
    </div>
    <div class="column">
      {% if selected_projekt %}
        {% for objekt in objekte %}
          <section class="card element-card objekt-card has-delete{% if selected_objekt and objekt.id == selected_objekt.id %} selected{% endif %}">
            <a href="{% url 'projekte_page' %}?projekt={{ selected_projekt.id }}&objekt={{ objekt.id }}">
              <h3>{{ objekt.nummer }}</br>{{ objekt.name }}</h3>
            </a>
            <form method="post" action="{% url 'objekt_delete' objekt.id %}">
              {% csrf_token %}
              <button type="submit" class="delete-btn action-btn" title="Löschen">
                <span class="icon">{% include "icons/trash.svg" %}</span>
              </button>
            </form>
          </section>
        {% empty %}
          <section class="card"><p>Keine Objekte vorhanden.</p></section>
        {% endfor %}
      {% endif %}
    </div>
    <div class="column">
      {% if selected_objekt %}
        {% for messung in messungen %}
          <section class="card element-card messung-card has-delete has-open{% if selected_messung and messung.id == selected_messung.id %} selected{% endif %}">
            <a href="{% url 'projekte_page' %}?projekt={{ selected_projekt.id }}&objekt={{ selected_objekt.id }}&messung={{ messung.id }}">
              <h4>{{ messung.name }}</h4>
            </a>
            <a href="{% url 'messung:page' %}?objekt={{ selected_objekt.id }}&messung={{ messung.id }}" class="open-btn action-btn" title="Messung öffnen">
              <span class="icon">{% include "icons/folder-open.svg" %}</span>
            </a>
            <form method="post" action="{% url 'messung_delete' messung.id %}">
              {% csrf_token %}
              <button type="submit" class="delete-btn action-btn" title="Löschen">
                <span class="icon">{% include "icons/trash.svg" %}</span>
              </button>
            </form>
          </section>
        {% empty %}
          <section class="card"><p>Keine Messungen vorhanden.</p></section>
        {% endfor %}
      {% endif %}
    </div>
  </div>
  {% if selected_messung %}
    <section class="card">
      {% include "measurement_table.html" with sequence_names=sequence_names table_rows=table_rows table_colspan=table_colspan show_comments=show_comments %}
    </section>
  {% endif %}
  {% include "context_stats_menu.html" %}
{% endblock %}
{% block extra_js %}
{% if selected_projekt or selected_objekt or selected_messung %}
<script>
  document.documentElement.classList.remove('sidebar-collapsed');
  document.body.classList.remove('sidebar-collapsed');
  try { localStorage.setItem('mm.sidebar.collapsed','0'); } catch(e){}
</script>
{% endif %}
<script>
  function collapse(selector){
    const body = document.querySelector(selector);
    const toggle = document.querySelector(`[data-target="${selector}"]`);
    if(body && toggle){
      body.classList.add('collapsed');
      toggle.classList.add('collapsed');
    }
  }

  document.querySelectorAll('.accordion-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = document.querySelector(btn.dataset.target);
      target.classList.toggle('collapsed');
      btn.classList.toggle('collapsed');
    });
  });

    {% if selected_messung %}
    collapse('#objekt-fields');
    {% endif %}

  document.querySelectorAll('.edit-form').forEach(form => {
    const saveBtn = form.querySelector('.save-btn');
    if(saveBtn){
      saveBtn.disabled = true;
      form.addEventListener('input', () => {
        saveBtn.disabled = false;
        saveBtn.classList.add('unsaved');
      });
      form.addEventListener('submit', () => {
        saveBtn.classList.remove('unsaved');
        saveBtn.disabled = true;
      });
    }
  });

  document.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const form = btn.closest('form');
      if(form){
        form.setAttribute('action', form.dataset.createUrl);
        form.querySelectorAll('input:not([type="hidden"]), textarea').forEach(el => {
          el.value = '';
        });
        const saveBtn = form.querySelector('.save-btn');
        if(saveBtn){
          saveBtn.disabled = false;
          saveBtn.classList.add('unsaved');
        }
        const toggle = form.querySelector('.accordion-toggle');
        const body = document.querySelector(toggle.dataset.target);
        if(body.classList.contains('collapsed')){
          body.classList.remove('collapsed');
          toggle.classList.remove('collapsed');
        }
      }
    });
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      e.preventDefault();
      const form = btn.closest('form');
      if (window.mmModal && form) {
        window.mmModal.open({
          title: 'Eintrag löschen?',
          text: 'Soll dieser Eintrag wirklich gelöscht werden?',
          okText: 'Löschen',
          onConfirm: () => form.submit()
        });
      } else if (form) {
        form.submit();
      }
    });
  });

  const selectedProjektId = {{ selected_projekt.id|default:"null" }};

  const projektSelect = document.getElementById('projekt-select');
  if(projektSelect){
    projektSelect.addEventListener('change', e => {
      const id = e.target.value;
      if(id){
        window.location.href = `?projekt=${id}`;
      }
    });
  }

  const objektSelect = document.getElementById('objekt-select');
  if(objektSelect){
    objektSelect.addEventListener('change', e => {
      const id = e.target.value;
      if(id){
        window.location.href = `?projekt=${selectedProjektId}&objekt=${id}`;
      }
    });
  }
</script>
<script type="module" src="{% static 'js/projekte.js' %}"></script>
{% endblock %}
